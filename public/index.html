<script>
    const socket = io();
    let myColor, currentRoom, currentTurn;
    let score = { captured: 0, lost: 0 };
    let selectedSquare = null;

    function toggleRules(show) {
        document.getElementById('modal-rules').style.display = show ? 'block' : 'none';
        document.getElementById('overlay').style.display = show ? 'block' : 'none';
    }

    function join() {
        currentRoom = document.getElementById('roomInput').value.toUpperCase();
        if(!currentRoom) return;
        socket.emit('joinRoom', currentRoom);
    }

    socket.on('playerAssign', (data) => {
        myColor = data.color;
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('stats-container').style.display = 'flex';
        document.getElementById('game-container').style.display = 'block';
        createBoard();
    });

    socket.on('startGame', (turn) => {
        currentTurn = turn;
        updateUI();
    });

    function createBoard() {
        const board = document.getElementById('board');
        board.innerHTML = '';
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const square = document.createElement('div');
                square.className = `square ${(r+c)%2===0?'light':'dark'}`;
                square.dataset.row = r; square.dataset.col = c;
                if ((r+c)%2!==0) {
                    if (r < 3) spawnPiece(square, 'black');
                    if (r > 4) spawnPiece(square, 'red');
                }
                square.onclick = () => handleSquareClick(square);
                board.appendChild(square);
            }
        }
    }

    function spawnPiece(parent, color) {
        const p = document.createElement('div');
        p.className = `piece ${color}`;
        p.dataset.type = 'normal'; // Pe√ßa normal ou dama
        parent.appendChild(p);
    }

    function handleSquareClick(square) {
        if (currentTurn !== myColor) return;
        const piece = square.querySelector('.piece');

        if (piece && piece.classList.contains(myColor)) {
            if(selectedSquare) selectedSquare.querySelector('.piece').classList.remove('selected');
            selectedSquare = square;
            piece.classList.add('selected');
        } else if (selectedSquare && !piece) {
            const fromR = parseInt(selectedSquare.dataset.row);
            const fromC = parseInt(selectedSquare.dataset.col);
            const toR = parseInt(square.dataset.row);
            const toC = parseInt(square.dataset.col);
            const movingPiece = selectedSquare.querySelector('.piece');
            const isKing = movingPiece.dataset.type === 'king';

            // L√≥gica de Movimento e Valida√ß√£o
            const distR = toR - fromR;
            const distC = Math.abs(toC - fromC);

            // 1. Movimento Diagonal Simples
            let isValid = false;
            let isCapture = false;

            if (isKing) {
                // Dama: Move qualquer dist√¢ncia na diagonal se o caminho estiver livre
                if (Math.abs(distR) === distC) isValid = true; 
            } else {
                // Normal: Apenas diagonal frente (Red sobe -, Black desce +)
                const direction = myColor === 'red' ? -1 : 1;
                if (distR === direction && distC === 1) isValid = true;
                
                // Normal: Captura (Pula 2 casas)
                if (Math.abs(distR) === 2 && distC === 2) {
                    const midR = (fromR + toR) / 2;
                    const midC = (fromC + toC) / 2;
                    const midSquare = document.querySelector(`[data-row="${midR}"][data-col="${midC}"]`);
                    const midPiece = midSquare.querySelector('.piece');
                    if (midPiece && !midPiece.classList.contains(myColor)) {
                        isValid = true;
                        isCapture = true;
                    }
                }
            }

            if (isValid) {
                socket.emit('movePiece', {
                    room: currentRoom,
                    color: myColor,
                    from: { r: fromR, c: fromC },
                    to: { r: toR, c: toC },
                    isCapture: isCapture,
                    becameKing: (myColor === 'red' && toR === 0) || (myColor === 'black' && toR === 7)
                });
                movingPiece.classList.remove('selected');
                selectedSquare = null;
            }
        }
    }

    socket.on('moveUpdate', (data) => {
        const from = document.querySelector(`[data-row="${data.from.r}"][data-col="${data.from.c}"]`);
        const to = document.querySelector(`[data-row="${data.to.r}"][data-col="${data.to.c}"]`);
        const piece = from.querySelector('.piece');

        if (data.isCapture) {
            const midR = (parseInt(data.from.r) + parseInt(data.to.r)) / 2;
            const midC = (parseInt(data.from.c) + parseInt(data.to.c)) / 2;
            document.querySelector(`[data-row="${midR}"][data-col="${midC}"]`).innerHTML = '';
            data.color === myColor ? score.captured++ : score.lost++;
        }

        if (data.becameKing) {
            piece.dataset.type = 'king';
            piece.style.border = "4px solid gold"; // Visual da Dama
            piece.innerHTML = "üëë"; // √çcone de Dama
            piece.style.display = "flex";
            piece.style.alignItems = "center";
            piece.style.justifyContent = "center";
        }

        if(piece) to.appendChild(piece);
        currentTurn = data.nextTurn;
        updateUI();
    });

    function updateUI() {
        document.getElementById('score-captured').innerText = score.captured;
        document.getElementById('score-lost').innerText = score.lost;
        const turnText = document.getElementById('current-turn-text');
        turnText.innerText = currentTurn === myColor ? "SUA VEZ" : "OPONENTE";
        turnText.style.color = currentTurn === myColor ? "#38bdf8" : "#f87171";
    }
</script>